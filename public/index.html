<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IF Talk - Voice-Powered Interactive Fiction</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@400;500;600&family=Literata:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <!-- Glk API and Dialog (required by ZVM) -->
  <script src="lib/dialog-stub.js"></script>
  <script src="lib/glkapi.js"></script>

  <!-- ifvms ZVM interpreter -->
  <script src="lib/zvm.js"></script>

  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay"></div>

  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <h2>üéÆ IF Talk - Settings</h2>
      <button id="closeSettingsBtn" class="close-settings-btn">‚úï</button>
    </div>

    <div class="settings-content">
      <!-- Current Game Display -->
      <div class="current-game-display" id="currentGameDisplay">
        <span class="current-game-label">Currently playing:</span>
        <span class="current-game-name" id="currentGameName">No game loaded</span>
      </div>

      <!-- Game Settings -->
      <div class="settings-section collapsible collapsed">
        <h3 class="section-header">üéÆ Game</h3>
        <div class="section-content">

          <!-- Quick Save/Restore Buttons -->
          <div class="game-actions">
            <button class="btn btn-primary btn-half-width" id="quickSaveBtn" title="F5">
              <span class="material-icons">save</span> Quick Save
            </button>
            <button class="btn btn-primary btn-half-width" id="quickRestoreBtn" title="F9">
              <span class="material-icons">restore</span> Quick Restore
            </button>
          </div>

          <!-- Return to Game Select -->
          <div class="game-actions">
            <button class="btn btn-secondary btn-full-width" id="selectGameBtn">
              <span class="material-icons">folder_open</span> Select Different Game
            </button>
          </div>

          <!-- Restart Game -->
          <div class="game-actions">
            <button class="btn btn-warning btn-full-width" id="restartGameBtn">
              <span class="material-icons">replay</span> Restart Current Game
            </button>
          </div>

          <!-- Save/Restore Instructions -->
          <div class="save-restore-info">
            <h4>üíæ Save & Restore</h4>
            <p>This browser-based interpreter uses the game's native save system:</p>
            <ul>
              <li>Type <code>SAVE</code> in the game to save your progress</li>
              <li>Type <code>RESTORE</code> to load a saved game</li>
              <li>Saves are stored in your browser's local storage</li>
            </ul>
          </div>

          <!-- Export/Import to File -->
          <div class="save-restore-info">
            <h4>üíæ Backup to Hard Drive</h4>
            <p>Export your save to a file for backup or to transfer between devices:</p>
          </div>
          <div class="game-actions">
            <button class="btn btn-secondary btn-half-width" id="exportSaveBtn">
              <span class="material-icons">download</span> Export Save
            </button>
            <button class="btn btn-secondary btn-half-width" id="importSaveBtn">
              <span class="material-icons">upload</span> Import Save
            </button>
          </div>

          <!-- Clear All Data -->
          <div class="save-restore-info">
            <h4>‚ö†Ô∏è Danger Zone</h4>
            <p>Permanently delete all saved games for all IF games:</p>
          </div>
          <div class="game-actions">
            <button class="btn btn-danger btn-full-width" id="clearAllDataBtn">
              <span class="material-icons">delete_forever</span> Clear All Save Data
            </button>
          </div>
        </div>
      </div>

      <!-- Voice Settings -->
      <div class="settings-section collapsible collapsed">
        <h3 class="section-header">üéôÔ∏è Voice Settings</h3>
        <div class="section-content">
        <p class="settings-description">Configure different voices for narration and app messages</p>
        <div class="voice-setting">
          <label for="speechRate">Speech Speed:</label>
          <div class="slider-container">
            <span class="slider-label">0.5x</span>
            <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="1.1" class="speech-slider">
            <span class="slider-label">1.5x</span>
          </div>
          <span id="speechRateValue" class="slider-value">1.1x</span>
        </div>
        <div class="voice-setting">
          <label for="voiceSelect">Narration Voice:</label>
          <select id="voiceSelect" class="voice-dropdown">
            <option value="">Loading voices...</option>
          </select>
          <button id="testVoiceBtn" class="btn-test-voice" title="Preview voice">‚ñ∂Ô∏è</button>
        </div>
        <div class="voice-setting">
          <label for="appVoiceSelect">App Voice (system messages):</label>
          <select id="appVoiceSelect" class="voice-dropdown">
            <option value="">Loading voices...</option>
          </select>
          <button id="testAppVoiceBtn" class="btn-test-voice" title="Preview app voice">‚ñ∂Ô∏è</button>
        </div>
        <p class="settings-help">‚≠ê = High-quality native voice (recommended). Only English voices shown.</p>
        </div>
      </div>

      <!-- Meta Commands (In-Game) -->
      <div class="settings-section collapsible collapsed">
        <h3 class="section-header">üí¨ Meta Commands</h3>
        <div class="section-content help-content">
          <div class="help-section">
            <p>Type these commands in-game. They're handled by IFTalk and won't be sent to the game.</p>
            <strong>Save/Load System:</strong>
            <ul>
              <li><code>SAVE</code> - Save game to named slot (max 5)</li>
              <li><code>RESTORE</code> - Restore from saved game</li>
              <li><code>DELETE SAVE</code> - Delete a saved game</li>
            </ul>
            <strong>How it works:</strong>
            <ol>
              <li>Type <code>SAVE</code> and press Enter</li>
              <li>See list of existing saves (or "No existing saves")</li>
              <li>Type a name for your save</li>
              <li>Game saves to that slot (or overwrites if exists)</li>
            </ol>
            <p><em>Note: You can have up to 5 named saves. To make more room, use DELETE SAVE.</em></p>
          </div>
        </div>
      </div>

      <!-- Voice Commands -->
      <div class="settings-section collapsible collapsed">
        <h3 class="section-header">üé§ Voice Commands</h3>
        <div class="section-content help-content">
          <div class="help-section">
            <strong>Navigation (Never sent to game):</strong>
            <ul>
              <li><code>"Restart"</code> - ‚è™ Go to beginning</li>
              <li><code>"Back"</code> - ‚¨ÖÔ∏è Previous sentence</li>
              <li><code>"Stop"</code> - ‚èπ Stop narration</li>
              <li><code>"Pause"</code> - ‚è∏ Pause</li>
              <li><code>"Play"</code> - ‚ñ∂ Resume/Start</li>
              <li><code>"Skip"</code> - ‚û°Ô∏è Next sentence</li>
              <li><code>"Skip All"</code> - ‚è© Skip to end</li>
              <li><code>"Status"</code> - üìä Read status bar</li>
              <li><code>"Quick Save"</code> - üíæ Quick save</li>
              <li><code>"Quick Load"</code> - üìÇ Quick load</li>
            </ul>
          </div>
          <div class="help-section">
            <strong>Game Commands (Sent to IF):</strong>
            <ul>
              <li><code>"Next"</code> / <code>"Continue"</code> / <code>"Enter"</code> / <code>"More"</code> - Press Enter</li>
              <li><code>"Print [text]"</code> - Send literal text</li>
            </ul>
          </div>
          <div class="help-section">
            <strong>Keyboard Shortcuts:</strong>
            <ul>
              <li><code>‚Üê/‚Üí</code> - Navigate sentences</li>
              <li><code>Ctrl (hold)</code> - Push-to-talk</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Pronunciation Dictionary -->
      <div class="settings-section collapsible collapsed">
        <h3 class="section-header">üó£Ô∏è Pronunciation Dictionary</h3>
        <div class="section-content">
        <p class="settings-description">Fix words that TTS pronounces incorrectly</p>
        <div id="pronunciationList" class="pronunciation-list"></div>
        <div class="add-pronunciation">
          <input type="text" id="newWord" placeholder="Word (e.g., Anchorhead)" class="pronunciation-input">
          <input type="text" id="newPronunciation" placeholder="Say as (e.g., Anchor-head)" class="pronunciation-input">
          <button id="addPronunciationBtn" class="btn-small btn-primary">+ Add</button>
        </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Welcome Screen -->
    <div class="welcome" id="welcome">
      <h2>Welcome to IF Talk</h2>
      <p>Play interactive fiction with voice control and narration.</p>

      <div class="game-list">
        <!-- Category 1: Your First Adventure -->
        <div class="game-category">
          <h3 class="category-title">üìú Your First Adventure</h3>
          <p class="category-desc">Short, forgiving games that are easy to pick up</p>
          <div class="game-category-grid">
            <button class="game-card" data-game="LostPig.z8">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Lost Pig</div>
              <div class="game-desc">Comedy adventure where you play an orc looking for a pig</div>
            </button>
            <button class="game-card" data-game="Dreamhold.z8">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">The Dreamhold</div>
              <div class="game-desc">Tutorial game designed to teach IF step-by-step</div>
            </button>
            <button class="game-card" data-game="Photopia.z5">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Photopia</div>
              <div class="game-desc">Award-winning story-driven experience</div>
            </button>
            <button class="game-card" data-game="905.z5">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">9:05</div>
              <div class="game-desc">Short game with a twist - perfect intro to IF</div>
            </button>
          </div>
        </div>

        <!-- Category 2: IF Masterpieces -->
        <div class="game-category">
          <h3 class="category-title">‚≠ê IF Masterpieces</h3>
          <p class="category-desc">Iconic stories that show what IF can do</p>
          <div class="game-category-grid">
            <button class="game-card" data-game="SpiderWeb.z5">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Spider and Web</div>
              <div class="game-desc">Espionage thriller with clever narrative puzzles</div>
            </button>
            <button class="game-card" data-game="Anchorhead.z8">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Anchorhead</div>
              <div class="game-desc">Lovecraftian horror - atmospheric masterpiece</div>
            </button>
            <button class="game-card" data-game="Trinity.z4">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Trinity</div>
              <div class="game-desc">Cold War time travel - thought-provoking</div>
            </button>
            <button class="game-card" data-game="Curses.z5">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Curses</div>
              <div class="game-desc">Classic exploration - first modern IF game</div>
            </button>
          </div>
        </div>

        <!-- Category 3: Ready for More -->
        <div class="game-category">
          <h3 class="category-title">üöÄ Ready for More</h3>
          <p class="category-desc">Continue your journey with these excellent adventures</p>
          <div class="game-category-grid">
            <button class="game-card" data-game="Planetfall.z3">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Planetfall</div>
              <div class="game-desc">Sci-fi adventure - meet Floyd the robot</div>
            </button>
            <button class="game-card" data-game="Violet.zblorb">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Violet</div>
              <div class="game-desc">One-room puzzle game with a unique voice</div>
            </button>
            <button class="game-card" data-game="WizardSniffer.zblorb">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">The Wizard Sniffer</div>
              <div class="game-desc">Comedy fantasy - play as a pig finding wizards</div>
            </button>
            <button class="game-card" data-game="Bronze.zblorb">
              <span class="save-badge" data-save-indicator></span>
              <div class="game-title">Bronze</div>
              <div class="game-desc">Fairy tale retelling - Beauty and the Beast</div>
            </button>
          </div>
        </div>

        <!-- IF Database Link + Custom URL -->
        <div class="if-database-section">
          <p>Want more? Browse thousands of games at the <a href="https://ifdb.org/" target="_blank" rel="noopener">Interactive Fiction Database</a></p>
          <div class="custom-url-section">
            <h4>Or play any Z-machine game by URL:</h4>
            <form class="custom-url-form" id="customUrlForm">
              <input type="url"
                     class="custom-url-input"
                     id="customUrlInput"
                     placeholder="https://ifarchive.org/if-archive/games/zcode/game.z8"
                     autocomplete="off">
              <button type="submit" class="custom-url-btn">
                <span class="material-icons">play_arrow</span>
                Play
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Output -->
    <div class="game-output hidden" id="gameOutput">
      <!-- Three-primitive Z-machine window model -->
      <div class="status-bar" id="statusBar"></div>
      <div class="upper-window" id="upperWindow"></div>
      <div class="lower-window" id="lowerWindow">
        <!-- Inline command input (hidden by default) -->
        <div class="command-line" id="commandLine" style="display: none;">
          <span class="command-prompt">&gt;</span>
          <input type="text" class="command-text" id="commandText" autocomplete="off" spellcheck="false">
          <span class="voice-indicator" id="voiceIndicator" title="Voice command">
            <span class="material-icons">mic</span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls Panel -->
  <div class="controls-wrapper">
    <!-- Navigation Controls -->
    <div class="controls hidden" id="controls">
      <button id="skipToStartBtn" class="btn-nav" title="&quot;Restart&quot;"><span class="material-icons">skip_previous</span></button>
      <button id="prevChunkBtn" class="btn-nav" title="&quot;Back&quot;"><span class="material-icons">fast_rewind</span></button>
      <button id="pausePlayBtn" class="btn-nav" title="&quot;Play&quot;"><span class="material-icons">play_arrow</span></button>
      <button id="nextChunkBtn" class="btn-nav" title="&quot;Skip&quot;"><span class="material-icons">fast_forward</span></button>
      <button id="skipToEndBtn" class="btn-nav" title="&quot;Skip All&quot;"><span class="material-icons">skip_next</span></button>
      <div class="controls-spacer"></div>
      <button id="settingsBtn" class="btn-nav btn-settings" title="Settings"><span class="material-icons">settings</span></button>
      <button id="muteBtn" class="btn-mic" title="Toggle voice input"><span class="material-icons">mic</span></button>
    </div>

    <!-- Message Input Row -->
    <div class="message-input-row hidden" id="messageInputRow">
      <input type="text" class="message-input" id="messageInput" placeholder="Type a command..." autocomplete="off" spellcheck="false">
      <button id="sendMessageBtn" class="btn-send" title="Send command">
        <span class="material-icons">send</span>
      </button>
    </div>

    <!-- Char Input Panel (replaces message input in char mode) -->
    <div class="char-input-panel hidden" id="charInputPanel">
      <!-- Arrow navigation -->
      <button class="btn-char-nav" id="charLeftBtn" title="Left Arrow" aria-label="Left Arrow">
        <span class="material-icons">arrow_back</span>
      </button>
      <button class="btn-char-nav" id="charUpBtn" title="Up Arrow" aria-label="Up Arrow">
        <span class="material-icons">arrow_upward</span>
      </button>
      <button class="btn-char-nav" id="charDownBtn" title="Down Arrow" aria-label="Down Arrow">
        <span class="material-icons">arrow_downward</span>
      </button>
      <button class="btn-char-nav" id="charRightBtn" title="Right Arrow" aria-label="Right Arrow">
        <span class="material-icons">arrow_forward</span>
      </button>

      <!-- Spacer to push Enter to the right -->
      <div class="char-input-spacer"></div>

      <!-- Keyboard button (opens virtual keyboard) -->
      <button class="btn-char-action" id="charKeyboardBtn" title="Type any key" aria-label="Open Keyboard">
        <span class="material-icons">keyboard</span>
      </button>

      <!-- Escape button -->
      <button class="btn-char-action" id="charEscBtn" title="Escape" aria-label="Escape Key">
        Esc
      </button>

      <!-- Enter button (rightmost, like Send button) -->
      <button class="btn-char-action btn-char-enter" id="charEnterBtn" title="Enter" aria-label="Enter Key">
        <span class="material-icons">send</span>
      </button>
    </div>
  </div>
</div>
  


  <div class="status" id="status">Select a game to start</div>

  <script type="module" src="js/app.js"></script>
</body>
</html>
